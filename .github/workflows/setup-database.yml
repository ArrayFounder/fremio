name: Setup Database and Import Members

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "confirm" to run database setup'
        required: true
        default: ''

jobs:
  setup-database:
    runs-on: ubuntu-latest
    name: Setup Database Tables and Import Members
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "confirm" ]; then
            echo "âŒ Confirmation not provided. Exiting."
            exit 1
          fi
          echo "âœ… Confirmation received. Proceeding..."
        
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true
          
      - name: Upload CSV files to server
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_BACKEND_PATH }}
        run: |
          echo "ðŸ“¤ Uploading CSV files from repository..."
          scp backend/data/transactions-1.csv $VPS_USER@$VPS_HOST:/tmp/transactions-1.csv
          scp backend/data/transactions-2.csv $VPS_USER@$VPS_HOST:/tmp/transactions-2.csv
          echo "âœ… CSV files uploaded successfully"
          
      - name: Setup database tables
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_BACKEND_PATH }}
        run: |
          echo "ðŸ”§ Setting up database tables..."
          
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
          cd $VPS_PATH || cd /var/www/fremio-backend || cd /var/www/fremio/backend
          
          echo "Installing dependencies..."
          npm install csv-parse 2>/dev/null || true
          
          echo "Running database setup script..."
          node scripts/setup-database-production.mjs
          
          echo "âœ… Database tables created successfully!"
          ENDSSH
          
      - name: Import members from CSV
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_BACKEND_PATH }}
        run: |
          echo "ðŸ“¥ Importing members..."
          
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
          cd $VPS_PATH || cd /var/www/fremio-backend || cd /var/www/fremio/backend
          
          # Check if CSV files exist in /tmp
          if [ -f "/tmp/transactions-1.csv" ] && [ -f "/tmp/transactions-2.csv" ]; then
            echo "Running import script..."
            node scripts/import-members-from-csv.mjs \
              /tmp/transactions-1.csv \
              /tmp/transactions-2.csv
            
            echo "Cleaning up temporary files..."
            rm -f /tmp/transactions-*.csv
            
            echo "âœ… Import completed successfully!"
          else
            echo "âš ï¸ CSV files not found in /tmp/"
            echo "Expected files:"
            echo "  - /tmp/transactions-1.csv"
            echo "  - /tmp/transactions-2.csv"
            exit 1
          fi
          ENDSSH
          
      - name: Restart backend
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "ðŸ”„ Restarting backend service..."
          ssh $VPS_USER@$VPS_HOST "pm2 restart fremio-backend || pm2 restart fremio-api || echo 'Please restart manually'"
          
      - name: Verify import
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "ðŸ” Verifying imported members..."
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
          psql -h localhost -U fremio_user -d fremio -c "
            SELECT COUNT(*) as total_active_members 
            FROM user_package_access 
            WHERE is_active = true AND access_end > NOW();
          "
          ENDSSH
          
      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/id_rsa
        
      - name: Notify success
        if: success()
        run: |
          echo "âœ… Database setup and member import completed!"
          echo "Please verify at: https://fremio.id/admin/subscribers"
